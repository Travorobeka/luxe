{% liquid
  assign main_menu = section.settings.main_menu
  assign mobile_menu = section.settings.mobile_menu

  if mobile_menu == blank
    assign menu = main_menu
  else
    assign menu = mobile_menu
  endif
%}
<div id="m-menu-drawer" class="m-menu-drawer">
  <div class="m-menu-drawer__bg" style="
    position: absolute; inset: 0; z-index: 0;
    background-color: #fff;
  "></div>
  <div class="m-menu-drawer__backdrop"></div>
  <div class="m-menu-drawer__wrapper">
    <!-- Custom close button removed: all close icon customizations will be applied to the hamburger/close icon in the header -->
    <div class="m-menu-drawer__content" style="
      padding-left: {{ section.settings.mb_drawer_padding_x | default: 24 }}px;
      padding-right: {{ section.settings.mb_drawer_padding_x | default: 24 }}px;
      padding-top: {{ section.settings.mb_drawer_padding_y | default: 24 }}px;
      padding-bottom: {{ section.settings.mb_drawer_padding_y | default: 24 }}px;
      position: relative;
      z-index: 1;
    ">
      <ul class="m-menu-drawer__navigation m-menu-mobile">
        {% for link in linklists[menu].links %}
          {% liquid
            assign title_handle = link.title | handleize
            assign has_mega_item = false
          %}
          {% for block in section.blocks %}
            {% liquid
              assign menu_title = block.settings.heading | handleize

              if menu_title == blank or menu_title != title_handle
                continue
              endif
            %}
            {% if menu_title == title_handle %}
              {% liquid
                assign has_mega_item = true
              %}
              {% case block.type %}
                {% when 'banner' %}
                  {% capture block_type %}
                    {% if block.settings.banner_image != blank %}
                      {% liquid
                        assign banner_class = 'm-mega-banner' | append: ' m-mega-banner--' | append: block.settings.banner_style
  
                        assign banner_link = block.settings.banner_link
                        assign banner_title = block.settings.banner_title
                        assign banner_desc = block.settings.banner_desc
                        assign banner_button_text = block.settings.banner_button_text
  
                        if banner_title == blank and banner_desc == blank and banner_button_text == blank
                          assign banner_class = banner_class | append: ' m-mega-banner--no-content'
                        endif
  
                      %}
                      <div class="{{ banner_class }}">
                        {% if banner_link != blank %}
                          <a href="{{ banner_link }}" class="m-hidden-link"><span class="m:visually-hidden">{{ banner_title | default: shop.name }}</span></a>
                        {% endif %}
                        <div class="m-mega-banner__image m:blocks-radius-md">
                          {% render 'responsive-image', image: block.settings.banner_image, sizes: '500px' %}
                        </div>
                        <div class="m-mega-banner__inner">
                          <div class="m-mega-banner__conntent">
                            <h4 class="m-mega-banner__title m:text-black">{{ banner_title }}</h4>
                            <p class="m-mega-banner__description">{{ banner_desc }}</p>
                          </div>
                          {% if banner_link != blank and banner_button_text != blank %}
                            <a href="{{ banner_link }}" class="m-mega-banner__button m:text-black m-button m-button--link">{{ banner_button_text }}</a>
                          {% endif %}
                        </div>
                      </div>
                    {% endif %}
                  {% endcapture %}
                {% when 'bloglist' %}
                  {% capture block_type %}
                      {% if block.settings.blog != blank %}
                        <div class="m-mega-blog-list m-mixed-layout m-mixed-layout--mobile-scroll" style="--column-gap: 16px" data-id="{{ block.id }}">
                          {% assign blog = blogs[block.settings.blog] %}
                          <ul class="m-mega-blog-list__wrapper m-mixed-layout__inner">
                            {% for article in blog.articles limit: 3 %}
                              <li class="m:column m:w-6/12">
                                <a href="{{ article.url }}" class="m-mega-article-card__image m:w-full m:blocks-radius-md m:block">
                                  {% render 'responsive-image',
                                    image: article.image,
                                    aspect_ratio: '16/9',
                                  %}
                                </a>
                                <div class="m-mega-article-card__content">
                                  {% if article.tags != blank %}
                                    <span class="m-mega-article-card__tag">{{ article.tags[0] }}</span>
                                  {% endif %}
                                  <a href="{{ article.url }}" class="m-mega-article-card__title">{{ article.title }}</a>
                                </div>
                              </li>
                            {% endfor %}
                          </ul>
                        </div>
                      {% endif %}
                    {% endcapture %}
                {% when 'product-list' %}
                  {% assign collection = block.settings.collection %}
                  {% if collection != blank %}
                    {% capture block_type %}
                      <div class="m-megamenu-mobile__products m-mixed-layout m-mixed-layout--mobile-scroll" style="--column-gap: 16px" data-id="{{ block.id }}">
                        {%- assign collection = collections[block.settings.collection] -%}
                        <div class="m-mixed-layout__inner">
                          {% for product in collection.products limit: block.settings.limit %}
                          {%- assign image_ratio = product.featured_image.aspect_ratio | default: '1/1' -%}
                            <div class="m:column m:w-1/2">
                              <div class="m-product-card m-product-card--style-1">
                                <div class="m-product-card__media">
                                  <a class="m-product-card__link m:block m:w-full" href="{{ product.url }}" aria-label="{{ product.title | default: forloop.index }}">
                                    <div class="m-product-card__main-image">
                                      {% render 'responsive-image',
                                        image: product.featured_image,
                                        aspect_ratio: image_ratio,
                                        sizes: '400px'
                                      %}
                                    </div>
                                  </a>
                                </div>
                                <div class="m-product-card__content m:text-left">
                                  <div class="m-product-card__info">
                                    <h3 class="m-product-card__title">
                                      <a href="{{ product.url }}" class="m-product-card__name">
                                        {{ product.title }}
                                      </a>
                                    </h3>
                                    <div class="m-product-card__price">
                                      {% render 'product-prices', product: product, is_product_card: true %}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                    {% endcapture %}
                  {% endif %}
                {% when 'collection-list' %}
                  {% liquid
                    assign collection_ids = 'collection_1,collection_2,collection_3,collection_4,collection_5,collection_6' | split: ','
                    assign content_empty = true

                    for collection_id in collection_ids
                      if block.settings[collection_id] != blank
                        assign content_empty = false
                      endif
                    endfor
                  %}
                  {% capture block_type %}
                    {% unless content_empty %}
                      {{ 'component-collection-card.css' | asset_url | stylesheet_tag }}
                      <div class="m-megamenu-mobile__collections m-mixed-layout m-mixed-layout--mobile-scroll" style="--column-gap: 16px" data-id="{{ block.id }}">
                        <div class="m-mixed-layout__inner">
                          {% for collection_id in collection_ids %}
                            {% liquid
                              if block.settings[collection_id] == blank
                                continue
                              endif
                              assign collection_handle = block.settings[collection_id]
                              assign collection = collections[collection_handle]
                              assign collection_image = collection.image
                              assign image_id = 'image_' | append: forloop.index

                              if block.settings[image_id] != blank
                                assign collection_image = block.settings[image_id]
                              endif

                              assign all_products_count = collection.all_products_count
                            %}
                            <div class="m:column m:w-6/12">
                              <div class="m-collection-card m-collection-card--standard m-collection-card--hover-scaling-up">
                                <div class="m-collection-card__inner">
                                  <a href="{{ collection.url | default: "#" }}" class="m-collection-card__image m:block m:w-full m:blocks-radius-md">
                                    {% if collection_image != blank %}
                                      {% render 'responsive-image', image: collection_image, image_class: 'm:w-full', aspect_ratio: aspect_ratio %}
                                    {% else %}
                                      <div style="--aspect-ratio: 1/1;">
                                        {% capture current %}{% cycle 1, 2, 3, 4, 5, 6 %}{% endcapture %}
                                        {{ 'collection-' | append: current | placeholder_svg_tag: 'm-placeholder-svg m:w-full m:h-full m:object-cover' }}
                                      </div>
                                    {% endif %}
                                  </a>
                                  <div class="m-collection-card__info m:text-left">
                                    <h3 class="m-collection-card__title">
                                      <a href="{{ collection.url | default: "#" }}" class="m-collection-card__link m:block">
                                        {{ title | default: collection.title }}
                                        <sup>{{ all_products_count }}</sup>
                                      </a>
                                    </h3>
                                  </div>
                                </div>
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                    {% endunless %}
                  {% endcapture %}
                {% when 'custom_html' %}
                  {% capture block_type %}
                    {% if block.settings.html != blank %}
                      <div class="m-mega-html m:text-black">
                        {{ block.settings.html }}
                      </div>
                    {% endif %}
                  {% endcapture %}
                {% else %}
                  {%- capture block_type -%}
                  {%- endcapture -%}
              {% endcase %}
            {% endif %}
          {% endfor %}
          {% if link.links != blank %}
            {% assign has_submenu = true %}
          {% else %}
            {% assign has_submenu = false %}
          {% endif %}
          {% comment %} Accordion toggle icon logic for both levels (inline, no macro) {% endcomment %}
          {% assign icon_type = section.settings.mb_menu_sub_toggle_icon_type | default: 'built-in' %}
          {% assign icon_placement = section.settings.mb_menu_sub_toggle_icon_placement | default: 'outside' %}
          {% comment %} Only accordion (dropdown) submenu behavior is supported. Remove slide logic. {% endcomment %}
          {% assign submenu_behavior = 'dropdown' %}

          {% capture render_toggle_icon %}
            {% if icon_type == 'custom' and section.settings.mb_menu_sub_toggle_icon_svg != blank %}
              {{ section.settings.mb_menu_sub_toggle_icon_svg }}
            {% else %}
              {% case section.settings.mb_menu_sub_toggle_icon %}
                {% when 'caret' %}
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                {% when 'arrow' %}
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                {% else %}
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 4V12M4 8H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              {% endcase %}
            {% endif %}
          {% endcapture %}

          <li class="m-menu-mobile__item" data-url="{{ link.url }}" data-index="{{ forloop.index0 }}" style="margin-bottom: {{ section.settings.mb_menu_btn_spacing | default: 12 }}px;">
            <a
              href="{{ link.url }}"
              class="m-menu-mobile__link"
              style="
                background: {{ section.settings.mb_menu_btn_bg | default: '#fff' }};
                border: {{ section.settings.mb_menu_btn_border_width | default: 1 }}px solid {{ section.settings.mb_menu_btn_border_color | default: '#e5e5e5' }};
                border-radius: {{ section.settings.mb_menu_btn_radius | default: 8 }}px;
                font-family: {{ section.settings.mb_menu_btn_font_family | font_family }};
                font-size: {{ section.settings.mb_menu_btn_font_size | default: 16 }}px;
                font-weight: {{ section.settings.mb_menu_btn_font_weight | default: 500 }};
                font-style: {{ section.settings.mb_menu_btn_font_style | default: 'normal' }};
                letter-spacing: {{ section.settings.mb_menu_btn_letter_spacing | default: 0.2 }}px;
                text-transform: {{ section.settings.mb_menu_btn_text_transform | default: 'none' }};
                padding: {{ section.settings.mb_menu_btn_padding_v | default: 12 }}px {{ section.settings.mb_menu_btn_padding_h | default: 16 }}px;
                display: flex;
                align-items: center;
                transition: background 0.2s;
              "
              onmouseover="this.style.background='{{ section.settings.mb_menu_btn_bg_hover | default: '#f5f5f5' }}'"
              onmouseout="this.style.background='{{ section.settings.mb_menu_btn_bg | default: '#fff' }}'"
              {% if has_submenu %}data-toggle-submenu="1"{% endif %}
            >
              {% if has_submenu and icon_placement == 'inside' %}
                <span>{{ link.title }}</span>
                <span class="m-menu-mobile__toggle-button" data-toggle-submenu="1" style="{% if section.settings.mb_menu_sub_toggle_icon_pos == 'left' %}order:-1;margin-right:8px;{% else %}order:1;margin-left:8px;{% endif %}">{{ render_toggle_icon }}</span>
              {% else %}
                <span>{{ link.title }}</span>
              {% endif %}
            </a>
            {% if has_submenu and icon_placement == 'outside' %}
              <span class="m-menu-mobile__toggle-button" data-toggle-submenu="1" style="{% if section.settings.mb_menu_sub_toggle_icon_pos == 'left' %}order:-1;margin-right:8px;{% else %}order:1;margin-left:8px;{% endif %}">{{ render_toggle_icon }}</span>
            {% endif %}
            {% if has_submenu %}
              <div class="m-megamenu-mobile m-megamenu-mobile--level-1 m-dropdown">
                <div class="m-megamenu-mobile__wrapper">
                  <ul class="m-submenu-mobile" style="font-size: {{ section.settings.mb_menu_sub_font_size | default: 14 }}px; color: {{ section.settings.mb_menu_sub_font_color | default: '#222' }}; padding-left: {{ section.settings.mb_menu_sub_indent | default: 16 }}px;">
                    {% for child in link.links %}
                      <li class="m-menu-mobile__item" data-url="{{ link.url }}">
                        <a
                          href="{{ child.url }}"
                          class="m-menu-mobile__link"
                          style="font-size: {{ section.settings.mb_menu_sub_font_size | default: 14 }}px; color: {{ section.settings.mb_menu_sub_font_color | default: '#222' }};"
                          {% if child.url contains '#' %}data-toggle-submenu="2"{% endif %}
                        >
                          {% if child.links != blank and icon_placement == 'inside' %}
                            <span>{{ child.title }}</span>
                            <span class="m-menu-mobile__toggle-button" data-toggle-submenu="2" style="{% if section.settings.mb_menu_sub_toggle_icon_pos == 'left' %}order:-1;margin-right:8px;{% else %}order:1;margin-left:8px;{% endif %}">{{ render_toggle_icon }}</span>
                          {% else %}
                            <span>{{ child.title }}</span>
                          {% endif %}
                        </a>
                        {% if child.links != blank and icon_placement == 'outside' %}
                          <span class="m-menu-mobile__toggle-button" data-toggle-submenu="2" style="{% if section.settings.mb_menu_sub_toggle_icon_pos == 'left' %}order:-1;margin-right:8px;{% else %}order:1;margin-left:8px;{% endif %}">{{ render_toggle_icon }}</span>
                        {% endif %}
                        {% if child.links != blank %}
                          <div class="m-megamenu-mobile m-megamenu-mobile--level-2 m-dropdown">
                            <div class="m-megamenu-mobile__wrapper">
                              <ul class="m-submenu-mobile" style="font-size: {{ section.settings.mb_menu_sub_font_size | default: 14 }}px; color: {{ section.settings.mb_menu_sub_font_color | default: '#222' }}; padding-left: {{ section.settings.mb_menu_sub_indent | default: 16 }}px;">
                                {% render 'mega-menu-link' for child.links as link %}
                              </ul>
                            </div>
                          </div>
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            {% endif %}
          </li>
        {% else %}
            {% render 'mega-menu-link' with link as link, has_mega_item: has_mega_item, block_type: block_type %}
        {% endfor %}
      </ul>
      {% render 'mega-menu-customer', section: section %}
    </div>
  </div>
</div>
